# worker_processes auto;

# pid /tmp/nginx.pid;

# events {
#     worker_connections 1024;
# }

# http {
#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;

#     client_body_temp_path /tmp/client_temp;
#     proxy_temp_path       /tmp/proxy_temp_path;
#     fastcgi_temp_path     /tmp/fastcgi_temp;
#     uwsgi_temp_path       /tmp/uwsgi_temp;
#     scgi_temp_path        /tmp/scgi_temp;

#     # Logging
#     access_log off;
#     error_log  /dev/stderr warn;

#     # Performance
#     sendfile        on;
#     tcp_nopush      on;
#     tcp_nodelay     on;
#     keepalive_timeout  65;
#     keepalive_requests 1000;

#     # Compression
#     gzip on;
#     gzip_vary on;
#     gzip_proxied any;
#     gzip_min_length 256;
#     gzip_comp_level 6;
#     gzip_types
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/javascript
#         application/x-javascript
#         application/json
#         application/xml
#         application/xml+rss
#         font/ttf
#         font/otf
#         image/svg+xml;

#     server {
#         listen       3000;
#         server_name  localhost;

#         root /usr/share/nginx/html;
#         index index.html;

#         # Angular Routing
#         location / {
#             try_files $uri $uri/ /index.html;
#         }

#         # Static Assets Caching
#         location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|map)$ {
#             expires 1y;
#             access_log off;
#             add_header Cache-Control "public, immutable";
#         }

#         # Optional: Explicit asset route
#         location /assets/ {
#             expires 1y;
#             add_header Cache-Control "public, immutable";
#         }
#     }
# }



















# server {
#     listen 80;

#     # عنوان الـ DNS الخاص بدوكر (ضروري جداً عند استخدام أسماء الخدمات)
#     resolver 127.0.0.11 valid=30s;

#     # 3. توجيه باقي الطلبات إلى تطبيق الأنجولار
#     location / {
#         set $frontend_angular http://resturantwebsite.angular:3000;
#         proxy_pass $frontend_angular;
        
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;

#         # دعم الـ Routing الخاص بـ Angular (SPA) لمنع خطأ 404 عند عمل Refresh
#         proxy_intercept_errors on;
#         error_page 404 = /index.html;
#     }
#     location ~ ^/(css|fonts|i18n|sass)/ {
#     set $frontend_angular http://resturantwebsite.angular:3000;
#     proxy_pass $frontend_angular; 
#    }
#     # 1. توجيه طلبات الـ API
#     location /api/ {
#         # نستخدم المتغيرات لتجنب خطأ "host not found" عند بدء التشغيل
#         set $backend_api http://resturantwebsite.api:8080;
        
#         proxy_pass $backend_api; # سيقوم بتوجيه /api/ لمثيلتها في الباك اند
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_cache_bypass $http_upgrade;
#     }

#     # 2. توجيه طلبات الصور والملفات الثابتة
#     location /assets/ {
#         set $backend_assets http://resturantwebsite.api:8080;
#         proxy_pass $backend_assets;
        
#         proxy_set_header Host $host;
#         proxy_cache_bypass $http_upgrade;
#     }


# }






server {
    listen 80;
    resolver 127.0.0.11 valid=30s;

    # 1. المجلدات الخاصة بالفرونت اند (Regex)
    # وضعنا علامة ^/ للتأكد من أنها تبدأ من الجذر
    location ~ ^/(assets|css|fonts|i18n|sass|img|projectImg)/ {
        set $frontend_angular http://resturantwebsite.angular:3000;
        proxy_pass $frontend_angular;
        
        # تعطيل الكاش لضمان رؤية الملفات الجديدة فوراً
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        proxy_set_header Host $host;

      
    }

    # 2. الصور والملفات المرفوعة (الباك اند)
    location /assets/ {
        set $backend_assets http://resturantwebsite.api:8080;
        proxy_pass $backend_assets;
        proxy_set_header Host $host;
    }

    # 3. الـ API
    location /api/ {
        set $backend_api http://resturantwebsite.api:8080;
        proxy_pass $backend_api;
        # ... باقي إعدادات البروكسي الخاصة بك
    }

    # 4. أي شيء آخر يذهب للأنجولار
    location / {
        set $frontend_angular http://resturantwebsite.angular:3000;
        proxy_pass $frontend_angular;
        proxy_intercept_errors on;
        error_page 404 = /index.html;
    }
}